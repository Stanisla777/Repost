<!DOCTYPE html>
<html>
<head lang="en">
 <meta charset="utf-8">
 <meta http-equiv="X-UA-Compatible" content="IE=edge">
 <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
 <meta name="google" value="notranslate">
 <meta name="theme-color" content="#ffffff">
 <title></title>
 <meta name="description" content="">
 <meta name="keywords" content="">
 <link href="css/style.css" rel="stylesheet">
 
</head>
<body>
<div class="section-diagram">
 <div class="container">
  <div class="diagram-wrap">
   <div class="diagram">
    <div class="diagram__body">
     <div class="flag-icon">
      <img src="./img/loyalty.svg" alt="">
     </div>
     <div class="summary-inform">
      <div class="summary-inform__total-percentage">
       <p>72.7</p>
       <span class="summary-inform__percent-icon">%</span>
      </div>
      <p class="summary-inform__title">Лояльность</p>
      <p class="summary-inform__index">Ниже среднего</p>
      <p class="summary-inform__value">
       по отрасли: FMCG значений слева от медианы <span>52.0</span> % - <span>83.1</span>%
      </p>
      <div class="summary-inform__changes summary-inform__growth">
       <div class="summary-inform__triangle"></div>
       <p>3.1</p>
      </div>
     </div>
     <svg width="100%" height="100%" viewBox="0 0 42 42" class="donut">
      <circle class="donut-ring" cx="21" cy="21" r="15.91549430918954" fill="transparent" stroke="#d2d3d4"></circle>
      <circle data-val="10" stroke-dashoffset="20" class="donut-segment" cx="21" cy="21" r="15.91549430918954"
              fill="transparent" stroke="#fcd329">
      </circle>
      <circle data-val="20" class="donut-segment" cx="21" cy="21" r="15.91549430918954" fill="transparent"
              stroke="#70a84b"></circle>
      <circle data-val="30" class="donut-segment" cx="21" cy="21" r="15.91549430918954" fill="transparent"
              stroke="#ed5243"></circle>
     </svg>
    </div>
   </div>
   <div class="indicators">
    <div class="indicators__item">
     <p class="indicators__key">Промоутеры</p>
     <div class="indicators__value">
      <div class="indicators__value-numbers">
       <p class="indicators__value-total"><span>32.0</span>%</p>
       <p class="indicators__real-number">81</p>
      </div>
      <div class="indicators__charts">
       <svg class="indicators__charts-svg" width="95" height="38" xmlns="http://www.w3.org/2000/svg"
            xmlns:svg="http://www.w3.org/2000/svg">
        <g class="layer">
         <path d="m2.5,2.5l90,0l0,33l-90,0l0,-33z" fill="#f9f9f9" id="svg_1" stroke="#ececec" stroke-width="2"/>
         <g class="indicators__svg plus">
          <rect fill="#70a74b" width="30%" height="24" class="svg_plus" stroke="#ececec" stroke-width="0" x="1.51563"
                y="2"/>
          <rect fill="rgba(112, 167, 75, 0.48)" width="30%" height="10.84375" class="svg_minus" stroke="#ececec"
                stroke-width="0" x="1.51563" y="25.625"/>
          <text class="charts-text" x="0" y="0">
           <tspan>1.2</tspan>
           %
          </text>
         </g>
        </g>
       </svg>
      </div>
     </div>
    </div>
    <div class="indicators__item">
     <p class="indicators__key">Скептики</p>
     <div class="indicators__value">
      <div class="indicators__value-numbers">
       <p class="indicators__value-total"><span>32.0</span>%</p>
       <p class="indicators__real-number">81</p>
      </div>
      <div class="indicators__charts">
       <svg class="indicators__charts-svg" width="95" height="38" xmlns="http://www.w3.org/2000/svg"
            xmlns:svg="http://www.w3.org/2000/svg">
        <g class="layer">
         <path d="m2.5,2.5l90,0l0,33l-90,0l0,-33z" fill="#f9f9f9" id="svg_1" stroke="#ececec" stroke-width="2"/>
         <g class="indicators__svg minus">
          <rect fill="#fbd229" width="30%" height="24" class="svg_plus" stroke="#ececec" stroke-width="0" x="1.51563"
                y="2"/>
          <rect fill="rgba(251, 210, 41, 0.48)" width="30%" height="10.84375" class="svg_minus" stroke="#ececec"
                stroke-width="0" x="1.51563" y="25.625"/>
          <text class="charts-text plus" x="0" y="0">
           <tspan>1.2</tspan>
           %
          </text>
         </g>
        </g>
       </svg>
      </div>
     </div>
    </div>
    <div class="indicators__item">
     <p class="indicators__key">Критики</p>
     <div class="indicators__value">
      <div class="indicators__value-numbers">
       <p class="indicators__value-total"><span>32.0</span>%</p>
       <p class="indicators__real-number">81</p>
      </div>
      <div class="indicators__charts">
       <svg class="indicators__charts-svg" width="95" height="38" xmlns="http://www.w3.org/2000/svg"
            xmlns:svg="http://www.w3.org/2000/svg">
        <g class="layer">
         <path d="m2.5,2.5l90,0l0,33l-90,0l0,-33z" fill="#f9f9f9" id="svg_1" stroke="#ececec" stroke-width="2"/>
         <g class="indicators__svg minus">
          <rect fill="#ed5243" width="30%" height="24" class="svg_plus" stroke="#ececec" stroke-width="0" x="1.51563"
                y="2"/>
          <rect fill="rgba(237, 82, 67, 0.48)" width="30%" height="10.84375" class="svg_minus" stroke="#ececec"
                stroke-width="0" x="1.51563" y="25.625"/>
          <text class="charts-text" x="0" y="0">
           <tspan>9.7</tspan>
           %
          </text>
         </g>
        </g>
       </svg>
      </div>
     </div>
    </div>
   </div>
  </div>
 </div>
</div>
<script>

  window.onload=function() {
    
    const data = document.querySelectorAll('.donut-segment')
    data.forEach(function (item, i, arr) {
      let data_line = item.getAttribute('data-val')
      data_line = parseFloat(data_line)

      if (data_line > 4) {
        data_line = parseFloat(data_line) - 3.3
      }
      let data_space = 100 - data_line
      item.setAttribute('style', `stroke-dasharray:${data_line} ${data_space}`)

      let sum = 0
      if (i !== 0) {
        const parent = item.closest('.donut')
        const child = parent.children
        const el = item.previousElementSibling
        let prev_dash = el.getAttribute('stroke-dashoffset')
        for (let ind = 2; ind < child.length; ind++) {
          let d = 1
          while (d < ind) {
            let data_line = parseFloat(child[d].getAttribute('data-val'))

            if (data_line > 4) {
              data_line = parseFloat(data_line) - 3.3
            }
            sum = data_line + sum;
            d++;
          }
          let strok = 100 - sum + 20
          child[ind].setAttribute('stroke-dashoffset', strok)
          sum = 0
        }
      }
    })

    const char_val = document.querySelectorAll('.charts-text tspan');
    for (let item of char_val) {
      let charts_text = item.textContent
      charts_text = parseFloat(charts_text)
      const parent = item.closest('.indicators__svg')
      if (parent.classList.contains('plus')) {
        const par_child = parent.children
        console.log(par_child);
        for (item of par_child) {
          if (item.classList.contains('svg_plus')) {
            let wid = 30 + charts_text
            item.setAttribute('width', wid + '%')
          }
          else if (item.classList.contains('svg_minus')) {
            let wid = 30 - charts_text
            item.setAttribute('width', wid + '%')
          }
          else if (item.classList.contains('charts-text')) {

          }
        }
        charts_text = '+' + charts_text
        item.textContent = charts_text
      }
      else {
        const par_child = parent.children
        for (item of par_child) {
          if (item.classList.contains('svg_plus')) {
            let wid = 30 - charts_text
            item.setAttribute('width', wid + '%')
          }
          else if (item.classList.contains('svg_minus')) {
            let wid = 30 + charts_text
            item.setAttribute('width', wid + '%')
          }
        }
        charts_text = '-' + charts_text
        item.textContent = charts_text
      }
    }

    function fractionAsInt(value) {
      const str = ("" + value).split(".")[1];

      let integ = value.toFixed()
      document.querySelector('.summary-inform__total-percentage p').textContent = integ

      const span = document.createElement('span');

      document.querySelector('.summary-inform__total-percentage p').append(span)
      document.querySelector('.summary-inform__total-percentage p span').prepend('.' + str)

    }

    let numeral = document.querySelector('.summary-inform__total-percentage p').textContent
    numeral = parseFloat(numeral)

    fractionAsInt(numeral)
  }
</script>
</body>
</html>